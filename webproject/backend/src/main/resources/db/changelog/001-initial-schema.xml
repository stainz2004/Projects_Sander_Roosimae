<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">


    <changeSet id="2025-21-11 Category table" author="Markus Käpp">
        <createTable tableName="category">
            <column name="id" type="bigserial" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="text">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet id="2025-03-10 Shop item table" author="Markus Käpp">
        <createTable tableName="shop_item">
            <column name="id" type="bigserial" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="text">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="text">
                <constraints nullable="false"/>
            </column>
            <column name="price" type="float4">
                <constraints nullable="false"/>
            </column>
            <column name="category_id" type="bigint">
                <constraints nullable="false"
                             foreignKeyName="fk_shop_item_category"
                             references="category(id)" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="2025-08-10 Shopping cart table" author="Gregor Gritsenko">
        <createTable tableName="cart_item">
            <column name="id" type="bigserial"  autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="user_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="shop_item_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="quantity" type="integer" defaultValue="1">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint
                baseTableName="cart_item"
                baseColumnNames="shop_item_id"
                constraintName="fk_cart_item_shop_item"
                referencedTableName="shop_item"
                referencedColumnNames="id"
                onDelete="CASCADE"/>
        <createIndex tableName="cart_item" indexName="idx_cart_user_id">
            <column name="user_id"/>
        </createIndex>
        <addUniqueConstraint tableName="cart_item"
                             columnNames="user_id, shop_item_id"
                             constraintName="unique_user_item"/>
    </changeSet>
    <changeSet id="2025-11-10 Customer" author="Sander">
        <createTable tableName="customer">
            <column name="id" type="bigserial"  autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="text">
                <constraints nullable="false"/>
            </column>
            <column name="username" type="text">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="email" type="text">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="password" type="text">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="2025-11-22 Review table" author="Markus">
        <createTable tableName="review">
            <column name="id" type="bigserial"  autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>

            <column name="customer_id" type="bigint">
                <constraints nullable="false"
                             foreignKeyName="fk_review_customer"
                             references="customer(id)"/>
            </column>

            <column name="shop_item_id" type="bigint">
                <constraints nullable="false"/>
            </column>

            <column name="rating" type="int">
                <constraints nullable="false"/>
            </column>

            <column name="comment" type="text"/>

            <column name="created_at" type="timestamp" defaultValueComputed="CURRENT_TIMESTAMP"/>
        </createTable>
        <addForeignKeyConstraint
                baseTableName="review"
                baseColumnNames="shop_item_id"
                referencedTableName="shop_item"
                referencedColumnNames="id"
                constraintName="fk_review_shop_item"
                onDelete="CASCADE"/>


    </changeSet>
    <changeSet id="2025-11-23 Coupon table" author="Sander">
        <createTable tableName="coupon">
            <column name="id" type="bigserial"  autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="code" type="text">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="discount" type="float4">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="2025-03-12 Orders table" author="Markus">
        <createTable tableName="orders">
            <column name="id" type="bigserial"  autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>

            <column name="customer_id" type="bigint">
                <constraints nullable="false"
                             foreignKeyName="fk_orders_customer"
                             references="customer(id)"/>
            </column>

            <column name="total_price" type="float4">
                <constraints nullable="false"/>
            </column>

            <column name="coupon_id" type="bigint">
                <constraints nullable="true"
                             foreignKeyName="fk_orders_coupon"
                             references="coupon(id)"/>
            </column>

            <column name="created_at" type="timestamp" defaultValueComputed="CURRENT_TIMESTAMP"/>
        </createTable>
    </changeSet>


    <changeSet id="2025-03-12 Order items table" author="Markus">
        <createTable tableName="order_item">
            <column name="id" type="bigserial"  autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>

            <column name="order_id" type="bigint">
                <constraints nullable="false"/>
            </column>

            <column name="shop_item_id" type="bigint">
                <constraints nullable="true"/>
            </column>

            <column name="name_snapshot" type="text"/>
            <column name="category_snapshot" type="text"/>
            <column name="unit_price" type="float4"/>
            <column name="quantity" type="int" defaultValueNumeric="1"/>
        </createTable>

        <!--  FK to orders (order delete deletes its items) -->
        <addForeignKeyConstraint
                baseTableName="order_item"
                baseColumnNames="order_id"
                constraintName="fk_order_item_order"
                referencedTableName="orders"
                referencedColumnNames="id"
                onDelete="CASCADE"/>

        <!--  FK to shop_item (shop item deletion sets it to null) -->
        <addForeignKeyConstraint
                baseTableName="order_item"
                baseColumnNames="shop_item_id"
                constraintName="fk_order_item_shop_item"
                referencedTableName="shop_item"
                referencedColumnNames="id"
                onDelete="SET NULL"/>
    </changeSet>
    <changeSet id="2025-12-27 add-product-url" author="Sander">
        <addColumn tableName="shop_item">
            <column name="product_url" type="text">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>
    <changeSet id="2025-12-29 add-role-related" author="Sander">
        <createTable tableName="roles">
            <column name="id" type="bigserial" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="name" type="varchar(50)">
                <constraints nullable="false" unique="true"/>
            </column>
        </createTable>
        <createTable tableName="user_roles">
            <column name="user_id" type="bigint"/>
            <column name="role_id" type="bigint"/>
        </createTable>

        <addForeignKeyConstraint baseTableName="user_roles" baseColumnNames="user_id"
                                 referencedTableName="customer" referencedColumnNames="id" constraintName="fk_userroles_user"/>
        <addForeignKeyConstraint baseTableName="user_roles" baseColumnNames="role_id"
                                 referencedTableName="roles" referencedColumnNames="id" constraintName="fk_userroles_role"/>
    </changeSet>

    <changeSet id="2025-12-29 insert-normal-roles" author="Sander">
        <insert tableName="roles">
            <column name="name" value="ROLE_USER"/>
        </insert>
        <insert tableName="roles">
            <column name="name" value="ROLE_ADMIN"/>
        </insert>
    </changeSet>

    <changeSet id="2025-12-29 one-admin-account" author="Sander">
        <insert tableName="customer">
            <column name="name" value="Administrator"/>
            <column name="username" value="admin"/>
            <column name="email" value="admin@gmail.com"/>
            <column name="password" value="$2a$10$tLBXAMzifxammw9moaGYnOLjITgNtwRukssUrmnsGn9LUj8jpzLgi"/>
        </insert>
        <insert tableName="user_roles">
            <column name="user_id" value="1"/>
            <column name="role_id" value="2"/>
        </insert>
    </changeSet>

</databaseChangeLog>
